<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ã›ã©ã‚Šãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Outfit:wght@400;600;700;800&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a26;
  --accent: #00e5a0;
  --accent2: #7c4dff;
  --warn: #ff6b35;
  --text: #f0f0f6;
  --text2: #9a9ab0;
  --border: rgba(255,255,255,0.08);
  --radius: 16px;
  --font-display: 'Outfit', sans-serif;
  --font-mono: 'Orbitron', monospace;
  --font-body: 'Noto Sans JP', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body { background: var(--bg); color: var(--text); font-family: var(--font-body); display: flex; flex-direction: column; }

/* Prevent scrollbar layout shift */
html { scrollbar-gutter: stable; }

/* HEADER */
.header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 100; backdrop-filter: blur(10px); flex-shrink: 0; }
.logo { font-family: var(--font-display); font-weight: 800; font-size: 20px; color: var(--accent); }
.session-badge { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px; letter-spacing: 0.5px; }
.session-badge.off { background: rgba(255,255,255,0.06); color: var(--text2); }
.session-badge.on  { background: rgba(0,229,160,0.15); color: var(--accent); border: 1px solid rgba(0,229,160,0.3); animation: badgePulse 2s ease-in-out infinite; }
@keyframes badgePulse { 0%,100%{opacity:1} 50%{opacity:0.7} }

/* TABS */
.tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-shrink: 0; }
.tab { padding: 12px 12px; font-size: 12px; font-weight: 700; color: var(--text2); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* PAGES â€” fill remaining viewport height */
.page { display: none; flex: 1; min-height: 0; max-width: 600px; width: 100%; margin: 0 auto; flex-direction: column; }
.page.active { display: flex; }

/* Fixed header area within each page (non-scrolling) */
.page-fixed { flex-shrink: 0; padding: 16px 16px 10px; }
.page-fixed .section-title:last-child { margin-bottom: 0; }

/* Scrollable list area within each page */
.page-scroll { flex: 1; min-height: 0; overflow-y: auto; padding: 6px 16px 16px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
/* Hide scrollbar visually but keep functional */
.page-scroll::-webkit-scrollbar { width: 0; background: transparent; }
.page-scroll { scrollbar-width: none; }

/* SESSION CARD */
.session-card { background: linear-gradient(135deg, #0d1f1a, #0f0f1e); border: 1px solid rgba(0,229,160,0.2); border-radius: var(--radius); padding: 24px 20px; margin-bottom: 16px; text-align: center; position: relative; overflow: hidden; }
.session-card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 50% 0%, rgba(0,229,160,0.06) 0%, transparent 70%); pointer-events: none; }
.session-title { font-size: 11px; color: var(--text2); margin-bottom: 6px; letter-spacing: 2px; text-transform: uppercase; position: relative; }
.session-store-label { font-size: 13px; color: var(--text2); margin-bottom: 12px; min-height: 20px; position: relative; }
.session-store-label span { color: var(--accent); font-weight: 700; }

/* ===== TIMER DISPLAY ===== */
.session-timer { display: none; margin-bottom: 18px; position: relative; padding: 8px 0; }
.session-timer.active { display: flex; align-items: baseline; justify-content: center; gap: 2px; }
.timer-group { display: flex; align-items: baseline; }
.timer-digit { font-family: var(--font-mono); font-size: 48px; font-weight: 700; color: var(--accent); letter-spacing: 2px; line-height: 1; text-shadow: 0 0 30px rgba(0,229,160,0.3); min-width: 1.15ch; text-align: center; display: inline-block; }
.timer-sep { font-family: var(--font-mono); font-size: 36px; font-weight: 400; color: var(--accent2); line-height: 1; padding: 0 3px; opacity: 0.7; position: relative; top: -2px; }
.timer-sep.blink { animation: sepBlink 1s step-end infinite; }
@keyframes sepBlink { 0%,100%{opacity:0.7} 50%{opacity:0.2} }
.timer-label { font-size: 10px; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-top: 6px; font-family: var(--font-display); }

.btn-session { display: inline-flex; align-items: center; gap: 8px; padding: 13px 28px; border-radius: 50px; font-size: 15px; font-weight: 700; font-family: var(--font-display); border: none; cursor: pointer; transition: all 0.2s; position: relative; }
.btn-session.start { background: linear-gradient(135deg, var(--accent), #00b37a); color: #001a10; }
.btn-session.stop  { background: linear-gradient(135deg, var(--warn), #cc4400); color: #fff; }
.btn-session:active { transform: scale(0.97); }
.btn-session:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; }

/* SECTION TITLE */
.section-title { font-size: 11px; font-weight: 700; color: var(--text2); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }

/* STORE CARDS */
.store-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; transition: all 0.2s; }
.store-card.selected   { border-color: var(--accent); background: rgba(0,229,160,0.05); box-shadow: 0 0 0 2px rgba(0,229,160,0.12); }
.store-card.checked-in { border-color: var(--accent); background: rgba(0,229,160,0.06); }
.store-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
.store-name { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.store-meta { font-size: 12px; color: var(--text2); display: flex; gap: 8px; flex-wrap: wrap; }
.store-dist { font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--accent2); white-space: nowrap; letter-spacing: 0.5px; }
.badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 20px; }
.badge.ok        { background: rgba(0,229,160,0.1);   color: var(--accent); }
.badge.never     { background: rgba(255,255,255,0.06); color: var(--text2); }
.badge.active-ci { background: rgba(0,229,160,0.2);   color: var(--accent); border: 1px solid rgba(0,229,160,0.4); }
.store-actions { margin-top: 10px; display: flex; gap: 8px; }
.btn-select { flex: 1; padding: 9px; border-radius: 10px; border: 1px solid var(--accent); background: transparent; color: var(--accent); font-size: 13px; font-weight: 700; font-family: var(--font-body); cursor: pointer; transition: all 0.2s; }
.btn-select.selected-btn { background: var(--accent); color: #001a10; }
.btn-checkin { flex: 1; padding: 9px; border-radius: 10px; border: none; font-size: 13px; font-weight: 700; font-family: var(--font-body); cursor: pointer; transition: all 0.2s; }
.btn-checkin.in  { background: var(--accent); color: #001a10; }
.btn-checkin.out { background: rgba(255,107,53,0.15); color: var(--warn); border: 1px solid rgba(255,107,53,0.3); }
.btn-checkin:active, .btn-select:active { transform: scale(0.98); }
.checkin-timer { font-family: var(--font-mono); font-size: 13px; color: var(--accent); font-weight: 600; margin-top: 6px; text-align: center; letter-spacing: 1px; }

/* GPS */
.btn-gps { display: flex; align-items: center; gap: 8px; width: 100%; padding: 12px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 14px; font-weight: 700; cursor: pointer; margin-bottom: 14px; transition: all 0.2s; }
.gps-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text2); flex-shrink: 0; }
.gps-dot.active { background: var(--accent); box-shadow: 0 0 6px var(--accent); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 200; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border-radius: 24px 24px 0 0; padding: 20px 18px 40px; width: 100%; max-width: 600px; border-top: 1px solid var(--border); animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1); max-height: 92dvh; overflow-y: auto; }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 18px; }
.modal-title { font-family: var(--font-display); font-size: 18px; font-weight: 800; margin-bottom: 18px; }

/* FORM */
.form-group { margin-bottom: 12px; }
.form-label { font-size: 11px; font-weight: 700; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; display: block; }
.form-input { width: 100%; padding: 11px 13px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 15px; font-family: var(--font-body); outline: none; transition: border-color 0.2s; }
.form-input:focus { border-color: rgba(0,229,160,0.4); }
.form-row { display: flex; gap: 8px; }
.form-row .form-group { flex: 1; }
.btn-primary  { width: 100%; padding: 13px; background: linear-gradient(135deg, var(--accent), #00b37a); color: #001a10; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; font-family: var(--font-display); cursor: pointer; margin-top: 8px; transition: all 0.2s; }
.btn-primary:active { transform: scale(0.98); }
.btn-secondary { width: 100%; padding: 11px; background: transparent; color: var(--text2); border: 1px solid var(--border); border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px; }

/* HISTORY ITEMS */
.history-item { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 13px 14px; margin-bottom: 8px; }
.history-store { font-size: 15px; font-weight: 700; margin-bottom: 3px; }
.history-meta { font-size: 12px; color: var(--text2); display: flex; gap: 10px; flex-wrap: wrap; }
.history-duration { font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--accent2); letter-spacing: 0.5px; }

/* MANAGE STORES */
.manage-store { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 13px 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
.manage-store-info { flex: 1; min-width: 0; }
.manage-store-name { font-size: 15px; font-weight: 700; }
.manage-store-addr { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.btn-icon { width: 34px; height: 34px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text2); font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.btn-icon.delete:active { background: rgba(255,107,53,0.15); color: var(--warn); }
.btn-icon.edit:active   { background: rgba(0,229,160,0.1); color: var(--accent); }
.btn-icon.chart:active  { background: rgba(124,77,255,0.15); color: var(--accent2); }

/* FAB */
.fab { position: fixed; bottom: 24px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--accent); border: none; color: #001a10; font-size: 24px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px rgba(0,229,160,0.3); display: flex; align-items: center; justify-content: center; z-index: 50; transition: all 0.2s; }
.fab:active { transform: scale(0.93); }

/* EMPTY */
.empty { text-align: center; padding: 40px 20px; color: var(--text2); }
.empty-icon { font-size: 40px; margin-bottom: 12px; }
.empty-text { font-size: 14px; line-height: 1.6; }

/* TOAST */
.toast { position: fixed; bottom: 84px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface2); border: 1px solid var(--border); border-radius: 50px; padding: 10px 20px; font-size: 13px; font-weight: 700; z-index: 300; opacity: 0; transition: all 0.3s; white-space: nowrap; max-width: 90vw; pointer-events: none; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===== STATS TAB ===== */
.stat-day { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 12px; overflow: hidden; }
.stat-day-header { padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.stat-day-header:active { background: var(--surface2); }
.stat-day-date { font-family: var(--font-display); font-size: 15px; font-weight: 800; color: var(--text); }
.stat-day-summary { font-size: 12px; color: var(--text2); margin-top: 2px; }
.stat-day-arrow { font-size: 12px; color: var(--text2); transition: transform 0.2s; }
.stat-day-arrow.open { transform: rotate(180deg); }
.stat-day-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }
.stat-day-body.open { display: block; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0; }
.stat-cell { background: var(--surface2); border-radius: 12px; padding: 12px; text-align: center; }
.stat-cell-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.stat-cell-value { font-family: var(--font-display); font-size: 18px; font-weight: 800; }
.stat-cell-value.accent  { color: var(--accent); }
.stat-cell-value.accent2 { color: var(--accent2); }
.stat-cell-value.warn    { color: var(--warn); }
.stat-cell-value.text2   { color: var(--text2); }
.stat-visit { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.stat-visit:last-child { border-bottom: none; }
.stat-visit-name { font-weight: 700; }
.stat-visit-time { color: var(--text2); font-size: 12px; }
.stat-visit-dur  { font-family: var(--font-mono); font-weight: 600; color: var(--accent2); font-size: 12px; letter-spacing: 0.5px; }

/* ===== STORE DETAIL MODAL ===== */
.store-detail-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
.store-detail-back { width: 34px; height: 34px; border-radius: 50%; background: var(--surface2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; flex-shrink: 0; }
.store-detail-title { font-family: var(--font-display); font-size: 18px; font-weight: 800; }
.chart-wrap { margin: 14px 0 8px; }
.chart-label { font-size: 11px; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
.chart-bars { display: flex; align-items: flex-end; gap: 6px; height: 80px; }
.chart-bar-col { display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; min-width: 0; }
.chart-bar { width: 100%; border-radius: 4px 4px 0 0; background: linear-gradient(180deg, var(--accent2), #4a2d99); transition: height 0.4s ease; min-height: 4px; }
.chart-bar.latest { background: linear-gradient(180deg, var(--accent), #00a070); }
.chart-bar-val { font-family: var(--font-mono); font-size: 9px; font-weight: 600; color: var(--text2); white-space: nowrap; letter-spacing: 0.5px; }
.chart-bar-idx { font-size: 9px; color: var(--text2); }
.store-hist-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.store-hist-item:last-child { border-bottom: none; }
.store-hist-date { font-size: 13px; font-weight: 700; }
.store-hist-time { font-size: 11px; color: var(--text2); }
.store-hist-dur  { font-family: var(--font-mono); font-weight: 600; color: var(--accent); font-size: 13px; letter-spacing: 0.5px; }
.trend-row { display: flex; gap: 8px; margin-bottom: 12px; }
.trend-chip { flex: 1; background: var(--surface2); border-radius: 10px; padding: 10px; text-align: center; }
.trend-chip-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
.trend-chip-val { font-family: var(--font-display); font-size: 15px; font-weight: 800; color: var(--accent); }
.trend-chip-val.down { color: var(--accent); }
.trend-chip-val.up   { color: var(--warn); }
.trend-chip-val.flat { color: var(--text2); }

/* ===== DATA TAB ===== */
.data-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; display: flex; gap: 14px; align-items: flex-start; }
.data-card-icon { font-size: 28px; flex-shrink: 0; margin-top: 2px; }
.data-card-body { flex: 1; min-width: 0; }
.data-card-title { font-family: var(--font-display); font-size: 15px; font-weight: 800; margin-bottom: 5px; }
.data-card-desc { font-size: 12px; color: var(--text2); line-height: 1.6; margin-bottom: 12px; }
.btn-data { width: 100%; padding: 11px; border-radius: 10px; font-size: 13px; font-weight: 700; font-family: var(--font-display); border: none; cursor: pointer; transition: all 0.2s; }
.btn-data.export { background: linear-gradient(135deg, var(--accent2), #4a2d99); color: #fff; }
.btn-data.import { background: linear-gradient(135deg, var(--accent), #00b37a); color: #001a10; }
.btn-data:active { transform: scale(0.98); }
.data-summary { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; }
.data-summary-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.data-summary-row:last-child { border-bottom: none; }
.data-summary-label { color: var(--text2); }
.data-summary-value { font-family: var(--font-mono); font-weight: 600; color: var(--accent); font-size: 12px; letter-spacing: 0.5px; }

/* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
.confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 400; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(6px); }
.confirm-overlay.open { display: flex; }
.confirm-box { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 24px 20px; width: 100%; max-width: 340px; text-align: center; animation: popIn 0.2s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes popIn { from{transform:scale(0.85);opacity:0} to{transform:scale(1);opacity:1} }
.confirm-icon { font-size: 36px; margin-bottom: 12px; }
.confirm-title { font-family: var(--font-display); font-size: 18px; font-weight: 800; margin-bottom: 8px; }
.confirm-msg { font-size: 13px; color: var(--text2); line-height: 1.6; margin-bottom: 20px; }
.confirm-btns { display: flex; gap: 10px; }
.confirm-btn { flex: 1; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 700; font-family: var(--font-display); border: none; cursor: pointer; transition: all 0.2s; }
.confirm-btn.cancel   { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.confirm-btn.ok-start { background: linear-gradient(135deg, var(--accent), #00b37a); color: #001a10; }
.confirm-btn.ok-stop  { background: linear-gradient(135deg, var(--warn), #cc4400); color: #fff; }
.confirm-btn:active { transform: scale(0.97); }

/* å±¥æ­´å‰Šé™¤ãƒœã‚¿ãƒ³ */
.btn-history-delete { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text2); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
.btn-history-delete:active { background: rgba(255,107,53,0.15); color: var(--warn); border-color: rgba(255,107,53,0.4); }
</style>
</head>
<body>

<div class="header">
  <div class="logo">ã›ã©ã‚Šãƒˆãƒ©ãƒƒã‚«ãƒ¼</div>
  <div class="session-badge off" id="sessionBadge">â— åœæ­¢ä¸­</div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('home',this)">ğŸ  ãƒ›ãƒ¼ãƒ </div>
  <div class="tab" onclick="switchTab('stores',this)">ğŸ—‚ åº—èˆ—</div>
  <div class="tab" onclick="switchTab('history',this)">ğŸ“‹ å±¥æ­´</div>
  <div class="tab" onclick="switchTab('stats',this)">ğŸ“Š çµ±è¨ˆ</div>
  <div class="tab" onclick="switchTab('data',this)">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿</div>
</div>

<!-- HOME -->
<div class="page active" id="tab-home">
  <div class="page-fixed">
    <div class="session-card">
      <div class="session-title">åº—èˆ—ã›ã©ã‚Š</div>
      <div class="session-store-label" id="sessionStoreLabel">å‡ºç™ºã—ãŸã‚‰é–‹å§‹ã—ã¦ãã ã•ã„</div>
      <div class="session-timer" id="sessionTimer">
        <div class="timer-group">
          <span class="timer-digit" id="timerH1">0</span><span class="timer-digit" id="timerH2">0</span>
        </div>
        <span class="timer-sep blink">:</span>
        <div class="timer-group">
          <span class="timer-digit" id="timerM1">0</span><span class="timer-digit" id="timerM2">0</span>
        </div>
        <span class="timer-sep blink">:</span>
        <div class="timer-group">
          <span class="timer-digit" id="timerS1">0</span><span class="timer-digit" id="timerS2">0</span>
        </div>
      </div>
      <button class="btn-session start" id="sessionBtn" onclick="toggleSession()">â–¶ åº—èˆ—ã›ã©ã‚Šé–‹å§‹</button>
    </div>
    <button class="btn-gps" onclick="refreshLocation()">
      <div class="gps-dot" id="gpsDot"></div>
      <span id="gpsText">ç¾åœ¨åœ°ã‚’å–å¾—ï¼ˆè·é›¢é †ã‚½ãƒ¼ãƒˆï¼‰</span>
    </button>
    <div class="section-title">ç™»éŒ²åº—èˆ—</div>
  </div>
  <div class="page-scroll">
    <div id="nearbyList"></div>
  </div>
</div>

<!-- STORES -->
<div class="page" id="tab-stores">
  <div class="page-fixed">
    <div class="section-title">ç™»éŒ²åº—èˆ—</div>
  </div>
  <div class="page-scroll">
    <div id="storesList"></div>
    <div style="height:80px"></div>
  </div>
</div>

<!-- HISTORY -->
<div class="page" id="tab-history">
  <div class="page-fixed">
    <div class="section-title">è¨ªå•å±¥æ­´</div>
  </div>
  <div class="page-scroll">
    <div id="historyList"></div>
  </div>
</div>

<!-- STATS -->
<div class="page" id="tab-stats">
  <div class="page-fixed">
    <div class="section-title">åº—èˆ—ã›ã©ã‚Šè¨˜éŒ²</div>
  </div>
  <div class="page-scroll">
    <div id="statsList">
      <div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">åº—èˆ—ã›ã©ã‚Šã‚’è¨˜éŒ²ã™ã‚‹ã¨<br>ã“ã“ã«çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div></div>
    </div>
  </div>
</div>

<!-- DATA -->
<div class="page" id="tab-data">
  <div class="page-fixed">
    <div class="section-title">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</div>
  </div>
  <div class="page-scroll">
    <div class="data-card">
      <div class="data-card-icon">ğŸ“¤</div>
      <div class="data-card-body">
        <div class="data-card-title">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        <div class="data-card-desc">åº—èˆ—ãƒ»è¨ªå•å±¥æ­´ãƒ»ã›ã©ã‚Šè¨˜éŒ²ã‚’ã™ã¹ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ»Dropboxãƒ»iCloudç­‰ã«ä¿å­˜ã§ãã¾ã™ã€‚æ©Ÿç¨®å¤‰æ›´æ™‚ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«æ´»ç”¨ãã ã•ã„ã€‚</div>
        <button class="btn-data export" onclick="exportData()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹</button>
      </div>
    </div>
    <div class="data-card">
      <div class="data-card-icon">ğŸ“¥</div>
      <div class="data-card-body">
        <div class="data-card-title">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
        <div class="data-card-desc">ä»¥å‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚Googleãƒ‰ãƒ©ã‚¤ãƒ–ãƒ»Dropboxãƒ»iCloudç­‰ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚<br><strong style="color:var(--warn)">âš ï¸ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆä¸Šæ›¸ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</strong><br><span style="color:var(--text2);font-size:11px">ğŸ’¡ iPhoneã§ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªãŒé–‹ãã¾ã™ã€‚å·¦ä¸Šã®ã€Œãƒ–ãƒ©ã‚¦ã‚ºã€ã‹ã‚‰Googleãƒ‰ãƒ©ã‚¤ãƒ–ç­‰ã‚’é¸æŠã§ãã¾ã™ï¼ˆå„ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ï¼‰</span></div>
        <button class="btn-data import" onclick="document.getElementById('importFile').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</button>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
      </div>
    </div>
    <div class="section-title" style="margin-top:20px">ãƒ‡ãƒ¼ã‚¿æ¦‚è¦</div>
    <div class="data-summary" id="dataSummary"></div>
  </div>
</div>

<!-- FAB -->
<button class="fab" onclick="openAddModal()" id="fab" style="display:none">ï¼‹</button>

<!-- åº—èˆ—è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">åº—èˆ—ã‚’è¿½åŠ </div>
    <div class="form-group">
      <label class="form-label">åº—èˆ—å *</label>
      <input type="text" class="form-input" id="fName" placeholder="ä¾‹ï¼šãƒ–ãƒƒã‚¯ã‚ªãƒ• â—‹â—‹åº—">
    </div>
    <div class="form-group">
      <label class="form-label">Googleãƒãƒƒãƒ— URLï¼ˆä»»æ„ï¼‰</label>
      <input type="url" class="form-input" id="fAddr" placeholder="Googleãƒãƒƒãƒ—ã§URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘" oninput="extractLatLng(this.value)">
      <div id="latlngStatus" style="font-size:12px;margin-top:6px;min-height:18px;"></div>
    </div>
    <div class="form-row" id="latlngRow">
      <div class="form-group">
        <label class="form-label">ç·¯åº¦</label>
        <input type="number" class="form-input" id="fLat" placeholder="è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™" step="0.000001">
      </div>
      <div class="form-group">
        <label class="form-label">çµŒåº¦</label>
        <input type="number" class="form-input" id="fLng" placeholder="è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™" step="0.000001">
      </div>
    </div>
    <button class="btn-primary" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);background-image:none" onclick="useCurrentLocation()">ğŸ“ ç¾åœ¨åœ°ã®åº§æ¨™ã‚’ä½¿ã†</button>
    <button class="btn-primary" onclick="saveStore()">ä¿å­˜ã™ã‚‹</button>
    <button class="btn-secondary" onclick="closeModalForce()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- åº—èˆ—åˆ¥å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="storeDetailOverlay" onclick="closeStoreDetail(event)">
  <div class="modal" id="storeDetailModal">
    <div class="modal-handle"></div>
    <div class="store-detail-header">
      <div class="store-detail-back" onclick="closeStoreDetailForce()">â†</div>
      <div class="store-detail-title" id="storeDetailTitle"></div>
    </div>
    <div id="storeDetailContent"></div>
  </div>
</div>

<!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="confirmIcon"></div>
    <div class="confirm-title" id="confirmTitle"></div>
    <div class="confirm-msg" id="confirmMsg"></div>
    <div class="confirm-btns">
      <button class="confirm-btn cancel" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="confirm-btn" id="confirmOkBtn" onclick="confirmOk()"></button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let stores   = JSON.parse(localStorage.getItem('sedori_stores')   || '[]');
let visits   = JSON.parse(localStorage.getItem('sedori_history')  || '[]');
let sessions = JSON.parse(localStorage.getItem('sedori_sessions') || '[]');
let session  = JSON.parse(localStorage.getItem('sedori_session')  || 'null');
let checkins = JSON.parse(localStorage.getItem('sedori_checkins') || '{}');
let currentLat = null, currentLng = null;
let sessionInterval = null, checkinIntervals = {};
let editingId = null, selectedStoreId = null;

function save() {
  localStorage.setItem('sedori_stores',   JSON.stringify(stores));
  localStorage.setItem('sedori_history',  JSON.stringify(visits));
  localStorage.setItem('sedori_sessions', JSON.stringify(sessions));
  localStorage.setItem('sedori_checkins', JSON.stringify(checkins));
  session ? localStorage.setItem('sedori_session', JSON.stringify(session))
          : localStorage.removeItem('sedori_session');
}

// ===== TABS =====
function switchTab(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  el.classList.add('active');
  document.getElementById('fab').style.display = name === 'stores' ? 'flex' : 'none';
  if (name === 'history') renderHistory();
  if (name === 'stores')  renderStoresList();
  if (name === 'stats')   renderStats();
  if (name === 'data')    renderDataSummary();
}

// ===== CONFIRM DIALOG =====
// â˜… BUG FIX: confirmCallback ã‚’ closeConfirm() ã§ null ã«ã—ãŸå¾Œã«å‘¼ã‚“ã§ã„ãŸãŸã‚
//    ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œãªã‹ã£ãŸã€‚ä¿®æ­£: å…ˆã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é€€é¿ã—ã¦ã‹ã‚‰ close ã™ã‚‹
let confirmCallback = null;
function showConfirm({ icon, title, msg, okLabel, okClass, onOk }) {
  document.getElementById('confirmIcon').textContent  = icon;
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').innerHTML = msg.replace(/\n/g, '<br>');
  const okBtn = document.getElementById('confirmOkBtn');
  okBtn.textContent = okLabel;
  okBtn.className   = 'confirm-btn ' + okClass;
  confirmCallback   = onOk;
  document.getElementById('confirmOverlay').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('open');
  confirmCallback = null;
}
function confirmOk() {
  const cb = confirmCallback;   // â˜… å…ˆã«é€€é¿
  closeConfirm();               // â˜… ã“ã‚Œã§ confirmCallback = null ã«ãªã‚‹ãŒ
  if (cb) cb();                 // â˜… é€€é¿ã—ãŸ cb ã‚’å®Ÿè¡Œã™ã‚‹ã®ã§å•é¡Œãªã—
}

// ===== SESSION =====
function toggleSession() {
  if (session) {
    const elapsed = formatDuration(Date.now() - session.start);
    showConfirm({
      icon: 'ğŸ', title: 'åº—èˆ—ã›ã©ã‚Šã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ',
      msg: 'ç¨¼åƒæ™‚é–“ ' + elapsed + '\nãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­ã®åº—èˆ—ã‚‚è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã™ã€‚',
      okLabel: 'çµ‚äº†ã™ã‚‹', okClass: 'ok-stop', onOk: doStopSession,
    });
  } else {
    showConfirm({
      icon: 'ğŸš€', title: 'åº—èˆ—ã›ã©ã‚Šã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ',
      msg: 'å‡ºç™ºã—ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ã‚‡ã†ã€‚\nåº—èˆ—åˆ°ç€å¾Œã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',
      okLabel: 'é–‹å§‹ã™ã‚‹', okClass: 'ok-start', onOk: doStartSession,
    });
  }
}

function doStartSession() {
  session = { id: 'sess_' + Date.now(), start: Date.now(), storeId: selectedStoreId || null };
  updateSessionUI();
  startSessionTimer();
  if (selectedStoreId) checkin(selectedStoreId, true);
  save();
  renderNearby();
  const s = selectedStoreId ? stores.find(x => x.id === selectedStoreId) : null;
  toast(s ? s.name + ' ã§åº—èˆ—ã›ã©ã‚Šé–‹å§‹ï¼' : 'åº—èˆ—ã›ã©ã‚Šé–‹å§‹ï¼');
}

function doStopSession() {
  const endTs = Date.now();
  Object.keys(checkins).forEach(id => checkout(id, true));
  sessions.unshift({
    id: session.id,
    date: new Date(session.start).toLocaleDateString('ja-JP'),
    startTs: session.start, endTs,
    totalMs: endTs - session.start,
    storeId: session.storeId,
  });
  session = null;
  clearInterval(sessionInterval); sessionInterval = null;
  selectedStoreId = null;
  updateSessionUI(); save(); renderNearby();
  toast('åº—èˆ—ã›ã©ã‚Šã‚’çµ‚äº†ã—ã¾ã—ãŸ');
}

function pad(n) { return String(n).padStart(2, '0'); }

function updateSessionUI() {
  const btn   = document.getElementById('sessionBtn');
  const badge = document.getElementById('sessionBadge');
  const timer = document.getElementById('sessionTimer');
  const label = document.getElementById('sessionStoreLabel');
  if (session) {
    btn.className = 'btn-session stop'; btn.innerHTML = 'â–  åº—èˆ—ã›ã©ã‚Šçµ‚äº†'; btn.disabled = false;
    badge.className = 'session-badge on'; badge.textContent = 'â— ã›ã©ã‚Šä¸­';
    timer.className = 'session-timer active';
    const s = session.storeId ? stores.find(x => x.id === session.storeId) : null;
    if (s) {
      label.innerHTML = `<span>${s.name}</span> ã§åº—èˆ—ã›ã©ã‚Šä¸­`;
    } else {
      label.textContent = 'åº—èˆ—ã›ã©ã‚Šä¸­';
    }
  } else {
    btn.className = 'btn-session start'; btn.innerHTML = 'â–¶ åº—èˆ—ã›ã©ã‚Šé–‹å§‹'; btn.disabled = false;
    badge.className = 'session-badge off'; badge.textContent = 'â— åœæ­¢ä¸­';
    timer.className = 'session-timer';
    setTimerDigits(0, 0, 0);
    if (selectedStoreId) {
      const s = stores.find(x => x.id === selectedStoreId);
      label.innerHTML = `<span>${s?.name}</span> ã‚’é¸æŠä¸­ï¼ˆè‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼‰`;
    } else {
      label.textContent = 'å‡ºç™ºã—ãŸã‚‰é–‹å§‹ã—ã¦ãã ã•ã„';
    }
  }
}

function setTimerDigits(h, m, s) {
  const hp = pad(h), mp = pad(m), sp = pad(s);
  document.getElementById('timerH1').textContent = hp[0];
  document.getElementById('timerH2').textContent = hp[1];
  document.getElementById('timerM1').textContent = mp[0];
  document.getElementById('timerM2').textContent = mp[1];
  document.getElementById('timerS1').textContent = sp[0];
  document.getElementById('timerS2').textContent = sp[1];
}

function startSessionTimer() {
  clearInterval(sessionInterval);
  sessionInterval = setInterval(() => {
    if (!session) return;
    const t = Math.floor((Date.now() - session.start) / 1000);
    setTimerDigits(Math.floor(t / 3600), Math.floor((t % 3600) / 60), t % 60);
  }, 1000);
  // å³åº§ã«1å›å®Ÿè¡Œ
  if (session) {
    const t = Math.floor((Date.now() - session.start) / 1000);
    setTimerDigits(Math.floor(t / 3600), Math.floor((t % 3600) / 60), t % 60);
  }
}

// ===== SELECT STORE =====
function selectStore(storeId) {
  if (session) return;
  selectedStoreId = selectedStoreId === storeId ? null : storeId;
  updateSessionUI();
  renderNearby();
}

// ===== GPS =====
function refreshLocation() {
  const dot = document.getElementById('gpsDot');
  const txt = document.getElementById('gpsText');
  dot.className = 'gps-dot'; txt.textContent = 'å–å¾—ä¸­...';
  if (!navigator.geolocation) { toast('GPSéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™'); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    currentLat = pos.coords.latitude; currentLng = pos.coords.longitude;
    dot.className = 'gps-dot active';
    txt.textContent = `ç¾åœ¨åœ°å–å¾—æ¸ˆã¿ (${currentLat.toFixed(4)}, ${currentLng.toFixed(4)})`;
    renderNearby(); toast('ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ');
  }, () => {
    dot.className = 'gps-dot'; txt.textContent = 'å–å¾—å¤±æ•— â€” ã‚¿ãƒƒãƒ—ã—ã¦å†è©¦è¡Œ';
    toast('GPSå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }, { enableHighAccuracy: true, timeout: 10000 });
}

function calcDist(la1, lo1, la2, lo2) {
  const R = 6371000, dLa = (la2-la1)*Math.PI/180, dLo = (lo2-lo1)*Math.PI/180;
  const a = Math.sin(dLa/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dLo/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function formatDist(m) { return m < 1000 ? `${Math.round(m)}m` : `${(m/1000).toFixed(1)}km`; }

// ===== NEARBY =====
function renderNearby() {
  const list = document.getElementById('nearbyList');
  if (!stores.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸª</div><div class="empty-text">åº—èˆ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>ã€Œåº—èˆ—ã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</div></div>`;
    return;
  }
  const sorted = stores.map(s => ({
    ...s, dist: (currentLat && s.lat && s.lng) ? calcDist(currentLat, currentLng, s.lat, s.lng) : null
  })).sort((a, b) => {
    if (a.dist === null && b.dist === null) return 0;
    if (a.dist === null) return 1; if (b.dist === null) return -1;
    return a.dist - b.dist;
  });
  list.innerHTML = sorted.map(s => buildStoreCard(s)).join('');
  sorted.forEach(s => { if (checkins[s.id]) startCheckinTimer(s.id); });
}

function buildStoreCard(s) {
  const last    = getLastVisitTs(s.id);
  const days    = last ? Math.floor((Date.now() - last) / 86400000) : null;
  const ci      = checkins[s.id];
  const isSel   = selectedStoreId === s.id;

  let badge = '';
  if (ci)              badge = `<span class="badge active-ci">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­</span>`;
  else if (days===null) badge = `<span class="badge never">æœªè¨ªå•</span>`;
  else if (days === 0)  badge = `<span class="badge ok">ä»Šæ—¥</span>`;
  else                  badge = `<span class="badge ok">${days}æ—¥å‰</span>`;

  const dist = s.dist !== null ? `<span class="store-dist">${formatDist(s.dist)}</span>` : '';

  const lastVisitText = days !== null ? (days === 0 ? 'æœ€çµ‚è¨ªå• ä»Šæ—¥' : `æœ€çµ‚è¨ªå• ${days}æ—¥å‰`) : '';

  const anyCheckedIn = Object.keys(checkins).length > 0;

  let actions = '';
  if (!session) {
    actions = `<div class="store-actions">
      <button class="btn-select ${isSel?'selected-btn':''}" onclick="selectStore('${s.id}')">
        ${isSel ? 'âœ“ é¸æŠä¸­' : 'ã“ã®åº—èˆ—ã‚’é¸æŠ'}
      </button></div>`;
  } else if (ci) {
    actions = `<div class="store-actions">
      <button class="btn-checkin out" onclick="checkout('${s.id}')">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</button>
    </div><div class="checkin-timer" id="ci-timer-${s.id}">æ»åœ¨ä¸­...</div>`;
  } else if (anyCheckedIn) {
    // ä»–ã®åº—èˆ—ãŒãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­ â†’ ã“ã®åº—èˆ—ã¯ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸å¯
    actions = `<div class="store-actions">
      <button class="btn-checkin in" disabled style="opacity:0.3;cursor:not-allowed">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</button>
    </div><div style="font-size:11px;color:var(--text2);text-align:center;margin-top:4px">ä»–ã®åº—èˆ—ã«æ»åœ¨ä¸­</div>`;
  } else {
    actions = `<div class="store-actions">
      <button class="btn-checkin in" onclick="checkin('${s.id}')">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</button>
    </div>`;
  }
  const cls = ['store-card', ci?'checked-in':'', isSel?'selected':''].filter(Boolean).join(' ');
  return `<div class="${cls}" id="scard-${s.id}">
    <div class="store-top">
      <div><div class="store-name">${s.name}</div>
        <div class="store-meta">${(s.lat && s.lng)?`<span>ğŸ“ ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}</span>`:''} ${lastVisitText?`<span>ğŸ“‹ ${lastVisitText}</span>`:''}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">${dist}${badge}</div>
    </div>${actions}</div>`;
}

// ===== CHECKIN / CHECKOUT =====
function checkin(storeId, silent=false) {
  checkins[storeId] = { start: Date.now(), sessionId: session?.id };
  save(); renderNearby(); startCheckinTimer(storeId);
  if (!silent) { const s = stores.find(x=>x.id===storeId); toast(`${s?.name} ã«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³`); }
}

function checkout(storeId, silent=false) {
  const ci = checkins[storeId]; if (!ci) return;
  const now = Date.now();
  const s = stores.find(x=>x.id===storeId);
  visits.unshift({
    storeId, storeName: s?.name||'ä¸æ˜',
    date:      new Date(ci.start).toLocaleDateString('ja-JP'),
    startTime: new Date(ci.start).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),
    endTime:   new Date(now).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}),
    duration:  now - ci.start,
    startTs:   ci.start,
    endTs:     now,
    sessionId: ci.sessionId || session?.id,
  });
  delete checkins[storeId];
  clearInterval(checkinIntervals[storeId]); delete checkinIntervals[storeId];
  save();
  if (!silent) { renderNearby(); toast(`ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ (${formatDuration(now - ci.start)})`); }
}

function startCheckinTimer(storeId) {
  clearInterval(checkinIntervals[storeId]);
  checkinIntervals[storeId] = setInterval(() => {
    const ci = checkins[storeId]; const el = document.getElementById(`ci-timer-${storeId}`);
    if (!ci || !el) { clearInterval(checkinIntervals[storeId]); return; }
    el.textContent = 'æ»åœ¨ ' + formatDuration(Date.now() - ci.start);
  }, 1000);
}

// ===== HISTORY =====
function getLastVisitTs(storeId) {
  const v = visits.find(h => h.storeId === storeId);
  return v ? (v.startTs || new Date(v.date.replace(/\//g,'-')).getTime()) : null;
}

function renderHistory() {
  const list = document.getElementById('historyList');
  if (!visits.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">ã¾ã è¨ªå•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
    return;
  }
  list.innerHTML = visits.map((h, idx) => `
    <div class="history-item">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div>
          <div class="history-store">${h.storeName}</div>
          <div class="history-meta">
            <span>ğŸ“… ${h.date}</span>
            <span>ğŸ• ${h.startTime} ã€œ ${h.endTime}</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
          <div class="history-duration">${formatDuration(h.duration)}</div>
          <button class="btn-history-delete" onclick="deleteVisit(${idx})" title="å‰Šé™¤">ğŸ—‘</button>
        </div>
      </div>
    </div>`).join('');
}

function deleteVisit(idx) {
  const h = visits[idx];
  showConfirm({
    icon: 'ğŸ—‘ï¸',
    title: 'ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
    msg: h.storeName + '\n' + h.date + ' ' + h.startTime + 'ã€œ' + h.endTime + ' (' + formatDuration(h.duration) + ')',
    okLabel: 'å‰Šé™¤ã™ã‚‹',
    okClass: 'ok-stop',
    onOk: () => {
      visits.splice(idx, 1);
      save();
      renderHistory();
      toast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
  });
}

// ===== STATS TAB =====
function renderStats() {
  const list = document.getElementById('statsList');
  if (!sessions.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">åº—èˆ—ã›ã©ã‚Šã‚’è¨˜éŒ²ã™ã‚‹ã¨<br>ã“ã“ã«çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div></div>`;
    return;
  }
  list.innerHTML = sessions.map((sess, idx) => {
    const sessVisits = visits.filter(v => v.sessionId === sess.id);
    const stayTotal  = sessVisits.reduce((a, v) => a + v.duration, 0);
    const moveMs     = sess.totalMs - stayTotal;
    const visitCount = sessVisits.length;
    const visitRows = sessVisits.map(v => `
      <div class="stat-visit">
        <div><div class="stat-visit-name">${v.storeName}</div>
          <div class="stat-visit-time">${v.startTime} ã€œ ${v.endTime}</div>
        </div>
        <div class="stat-visit-dur">${formatDuration(v.duration)}</div>
      </div>`).join('');
    return `
      <div class="stat-day">
        <div class="stat-day-header" onclick="toggleStatDay('sd-${idx}', this)">
          <div>
            <div class="stat-day-date">ğŸ“… ${sess.date}</div>
            <div class="stat-day-summary">ç·ç¨¼åƒ ${formatDuration(sess.totalMs)} ï¼ ${visitCount}åº—èˆ—</div>
          </div>
          <span class="stat-day-arrow">â–¼</span>
        </div>
        <div class="stat-day-body" id="sd-${idx}">
          <div class="stat-grid" style="margin-top:14px">
            <div class="stat-cell">
              <div class="stat-cell-label">ç·ç¨¼åƒæ™‚é–“</div>
              <div class="stat-cell-value accent">${formatDuration(sess.totalMs)}</div>
            </div>
            <div class="stat-cell">
              <div class="stat-cell-label">è¨ªå•åº—èˆ—æ•°</div>
              <div class="stat-cell-value accent2">${visitCount}åº—</div>
            </div>
            <div class="stat-cell">
              <div class="stat-cell-label">åº—èˆ—æ»åœ¨åˆè¨ˆ</div>
              <div class="stat-cell-value text2">${formatDuration(stayTotal)}</div>
            </div>
            <div class="stat-cell">
              <div class="stat-cell-label">ç§»å‹•+ä¼‘æ†©æ™‚é–“</div>
              <div class="stat-cell-value warn">${moveMs >= 0 ? formatDuration(moveMs) : 'â€”'}</div>
            </div>
          </div>
          ${visitCount > 0 ? `
          <div class="section-title" style="margin-top:4px">è¨ªå•è©³ç´°</div>
          ${visitRows}` : '<div style="color:var(--text2);font-size:13px;padding-top:8px">ã“ã®åº—èˆ—ã›ã©ã‚Šã®è¨ªå•è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
          <button onclick="deleteSession('${sess.id}', ${visitCount})" style="width:100%;margin-top:14px;padding:10px;border-radius:10px;border:1px solid rgba(255,107,53,0.3);background:rgba(255,107,53,0.08);color:var(--warn);font-size:13px;font-weight:700;font-family:var(--font-body);cursor:pointer;transition:all 0.2s">ğŸ—‘ ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤</button>
        </div>
      </div>`;
  }).join('');
}

function deleteSession(sessionId, visitCount) {
  const sess = sessions.find(s => s.id === sessionId);
  if (!sess) return;
  const msg = visitCount > 0
    ? `${sess.date} ã®åº—èˆ—ã›ã©ã‚Šè¨˜éŒ²ã¨ã€ç´ã¥ã ${visitCount}ä»¶ ã®è¨ªå•å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`
    : `${sess.date} ã®åº—èˆ—ã›ã©ã‚Šè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
  showConfirm({
    icon: 'ğŸ—‘ï¸',
    title: 'ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
    msg,
    okLabel: 'å‰Šé™¤ã™ã‚‹',
    okClass: 'ok-stop',
    onOk: () => {
      // ç´ã¥ãè¨ªå•å±¥æ­´ã‚‚å‰Šé™¤
      visits = visits.filter(v => v.sessionId !== sessionId);
      sessions = sessions.filter(s => s.id !== sessionId);
      save();
      renderStats();
      toast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    }
  });
}

function toggleStatDay(id, header) {
  const body  = document.getElementById(id);
  const arrow = header.querySelector('.stat-day-arrow');
  const open  = body.classList.toggle('open');
  arrow.classList.toggle('open', open);
}

// ===== STORES MANAGEMENT =====
function renderStoresList() {
  const list = document.getElementById('storesList');
  if (!stores.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸª</div><div class="empty-text">ã¾ã åº—èˆ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</div></div>`;
    return;
  }
  list.innerHTML = stores.map(s => {
    const storeVisits = visits.filter(v => v.storeId === s.id);
    const visitCount  = storeVisits.length;
    const lastTs = getLastVisitTs(s.id);
    const daysSince = lastTs ? Math.floor((Date.now() - lastTs) / 86400000) : null;
    const lastVisitText = daysSince !== null ? (daysSince === 0 ? 'æœ€çµ‚è¨ªå• ä»Šæ—¥' : `æœ€çµ‚è¨ªå• ${daysSince}æ—¥å‰`) : '';
    return `
    <div class="manage-store">
      <div class="manage-store-info">
        <div class="manage-store-name">${s.name}</div>
        <div class="manage-store-addr">${s.lat ? `ğŸ“ ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}` : (s.addr ? 'ğŸ”— ãƒãƒƒãƒ—URLç™»éŒ²æ¸ˆã¿ï¼ˆåº§æ¨™æŠ½å‡ºå¤±æ•—ï¼‰' : 'ğŸ“ åº§æ¨™æœªè¨­å®š')}</div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">
          ${visitCount > 0 ? `ğŸ“‹ ${visitCount}å›è¨ªå•` : 'æœªè¨ªå•'}
          ${lastVisitText ? ` &nbsp;Â· ${lastVisitText}` : ''}
        </div>
      </div>
      <button class="btn-icon chart" onclick="openStoreDetail('${s.id}')" title="å±¥æ­´ã‚’è¦‹ã‚‹">ğŸ“ˆ</button>
      <button class="btn-icon edit"  onclick="openEditModal('${s.id}')">âœï¸</button>
      <button class="btn-icon delete" onclick="deleteStore('${s.id}')">ğŸ—‘ï¸</button>
    </div>`; }).join('');
}

// ===== STORE DETAIL MODAL =====
function openStoreDetail(storeId) {
  const s = stores.find(x => x.id === storeId);
  if (!s) return;
  document.getElementById('storeDetailTitle').textContent = s.name;
  const storeVisits = visits.filter(v => v.storeId === storeId).slice().reverse();
  const content     = document.getElementById('storeDetailContent');
  if (!storeVisits.length) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">ã¾ã è¨ªå•è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
  } else {
    const durs   = storeVisits.map(v => v.duration);
    const avgMs  = durs.reduce((a,b)=>a+b,0) / durs.length;
    const minMs  = Math.min(...durs);
    const maxMs  = Math.max(...durs);
    const last3  = durs.slice(-3);
    const first3 = durs.slice(0, Math.min(3, durs.length));
    let trendLabel = 'â€”', trendClass = 'flat';
    if (durs.length >= 3) {
      const recentAvg = last3.reduce((a,b)=>a+b,0)/last3.length;
      const earlyAvg  = first3.reduce((a,b)=>a+b,0)/first3.length;
      const diff = recentAvg - earlyAvg;
      if (diff < -60000)      { trendLabel = 'ğŸ“‰ çŸ­ç¸®ä¸­';   trendClass = 'down'; }
      else if (diff > 60000)  { trendLabel = 'ğŸ“ˆ å¢—åŠ ä¸­';   trendClass = 'up'; }
      else                    { trendLabel = 'â¡ æ¨ªã°ã„';   trendClass = 'flat'; }
    }
    const maxDur = Math.max(...durs);
    const bars = storeVisits.map((v, i) => {
      const pct = maxDur > 0 ? (v.duration / maxDur) * 100 : 0;
      const isLatest = i === storeVisits.length - 1;
      return `<div class="chart-bar-col">
        <div class="chart-bar-val">${formatDurationShort(v.duration)}</div>
        <div class="chart-bar ${isLatest?'latest':''}" style="height:${Math.max(pct * 0.7, 4)}px"></div>
        <div class="chart-bar-idx">${i+1}</div>
      </div>`;
    }).join('');
    const histRows = storeVisits.slice().reverse().map(v => `
      <div class="store-hist-item">
        <div><div class="store-hist-date">${v.date}</div>
          <div class="store-hist-time">${v.startTime} ã€œ ${v.endTime}</div>
        </div>
        <div class="store-hist-dur">${formatDuration(v.duration)}</div>
      </div>`).join('');
    content.innerHTML = `
      <div class="trend-row">
        <div class="trend-chip"><div class="trend-chip-label">å¹³å‡æ»åœ¨</div><div class="trend-chip-val">${formatDuration(avgMs)}</div></div>
        <div class="trend-chip"><div class="trend-chip-label">æœ€çŸ­</div><div class="trend-chip-val">${formatDuration(minMs)}</div></div>
        <div class="trend-chip"><div class="trend-chip-label">å‚¾å‘</div><div class="trend-chip-val ${trendClass}">${trendLabel}</div></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-label">æ»åœ¨æ™‚é–“ã®æ¨ç§»ï¼ˆç·‘ï¼ç›´è¿‘ï¼‰</div>
        <div class="chart-bars">${bars}</div>
      </div>
      <div class="section-title" style="margin-top:16px">è¨ªå•å±¥æ­´</div>
      ${histRows}`;
  }
  document.getElementById('storeDetailOverlay').classList.add('open');
}

function closeStoreDetail(e) { if (e.target === document.getElementById('storeDetailOverlay')) closeStoreDetailForce(); }
function closeStoreDetailForce() { document.getElementById('storeDetailOverlay').classList.remove('open'); }

// ===== GOOGLE MAPS URL PARSER =====
function parseLatLng(url) {
  const m1 = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
  if (m1) return { lat: parseFloat(m1[1]), lng: parseFloat(m1[2]) };
  const m2 = url.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
  if (m2) return { lat: parseFloat(m2[1]), lng: parseFloat(m2[2]) };
  const m3 = url.match(/ll=(-?\d+\.\d+),(-?\d+\.\d+)/);
  if (m3) return { lat: parseFloat(m3[1]), lng: parseFloat(m3[2]) };
  const m4 = url.match(/!3d(-?\d+\.\d+).*?!4d(-?\d+\.\d+)/);
  if (m4) return { lat: parseFloat(m4[1]), lng: parseFloat(m4[2]) };
  return null;
}

function setLatLngResult(lat, lng) {
  const status = document.getElementById('latlngStatus');
  if (lat && lng && Math.abs(lat) <= 90 && Math.abs(lng) <= 180) {
    document.getElementById('fLat').value = lat.toFixed(6);
    document.getElementById('fLng').value = lng.toFixed(6);
    status.style.color = 'var(--accent)';
    status.textContent = 'âœ… åº§æ¨™ã‚’å–å¾—ã—ã¾ã—ãŸ (' + lat.toFixed(4) + ', ' + lng.toFixed(4) + ')';
    return true;
  }
  return false;
}

function extractLatLng(url) {
  const status = document.getElementById('latlngStatus');
  if (!url) { status.textContent = ''; return; }
  const direct = parseLatLng(url);
  if (direct && setLatLngResult(direct.lat, direct.lng)) return;
  document.getElementById('fLat').value = '';
  document.getElementById('fLng').value = '';
  status.style.color = 'var(--warn)';
  status.textContent = url.length > 10 ? 'âš ï¸ åº§æ¨™ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆGoogleãƒãƒƒãƒ—ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®URLã‚’ãŠè©¦ã—ãã ã•ã„ï¼ˆã‚¢ãƒ—ãƒªã®å…±æœ‰URLã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼‰' : '';
}

// ===== EXPORT / IMPORT =====
function exportData() {
  const payload = { version: 1, exportedAt: new Date().toISOString(), stores, visits, sessions };
  const json = JSON.stringify(payload, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const date = new Date().toISOString().slice(0, 10);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `sedori-tracker-${date}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.version || !Array.isArray(data.stores)) {
        toast('âš ï¸ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¯¾å¿œã—ã¦ã„ãªã„å½¢å¼ã§ã™'); return;
      }
      let addedStores = 0, addedVisits = 0, addedSessions = 0;
      const existingStoreIds   = new Set(stores.map(s => s.id));
      const existingVisitKeys  = new Set(visits.map(v => v.startTs + '_' + v.storeId));
      const existingSessionIds = new Set(sessions.map(s => s.id));
      (data.stores || []).forEach(s => {
        if (!existingStoreIds.has(s.id)) { stores.push(s); addedStores++; }
      });
      (data.visits || data.history || []).forEach(v => {
        const key = v.startTs + '_' + v.storeId;
        if (!existingVisitKeys.has(key)) { visits.push(v); addedVisits++; }
      });
      (data.sessions || []).forEach(s => {
        if (!existingSessionIds.has(s.id)) { sessions.push(s); addedSessions++; }
      });
      visits.sort((a, b) => (b.startTs || 0) - (a.startTs || 0));
      sessions.sort((a, b) => (b.startTs || 0) - (a.startTs || 0));
      save(); renderDataSummary(); renderStoresList();
      toast(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº† åº—èˆ—+${addedStores} å±¥æ­´+${addedVisits} è¨˜éŒ²+${addedSessions}`);
    } catch {
      toast('âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

function renderDataSummary() {
  const el = document.getElementById('dataSummary');
  if (!el) return;
  const keys = ['sedori_stores','sedori_history','sedori_sessions','sedori_checkins','sedori_session'];
  let totalBytes = 0;
  keys.forEach(k => { totalBytes += (localStorage.getItem(k) || '').length * 2; });
  const sizeStr = totalBytes < 1024 ? totalBytes + ' B'
                : totalBytes < 1048576 ? (totalBytes/1024).toFixed(1) + ' KB'
                : (totalBytes/1048576).toFixed(2) + ' MB';
  el.innerHTML = `
    <div class="data-summary-row"><span class="data-summary-label">ç™»éŒ²åº—èˆ—æ•°</span><span class="data-summary-value">${stores.length} ä»¶</span></div>
    <div class="data-summary-row"><span class="data-summary-label">è¨ªå•å±¥æ­´</span><span class="data-summary-value">${visits.length} ä»¶</span></div>
    <div class="data-summary-row"><span class="data-summary-label">ã›ã©ã‚Šè¨˜éŒ²</span><span class="data-summary-value">${sessions.length} ä»¶</span></div>
    <div class="data-summary-row"><span class="data-summary-label">ä½¿ç”¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</span><span class="data-summary-value">${sizeStr}</span></div>
  `;
}

// ===== ADD/EDIT MODAL =====
function openAddModal() {
  editingId = null;
  ['fName','fAddr','fLat','fLng'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('latlngStatus').textContent = '';
  document.getElementById('modalTitle').textContent = 'åº—èˆ—ã‚’è¿½åŠ ';
  document.getElementById('modalOverlay').classList.add('open');
}
function openEditModal(id) {
  const s = stores.find(x=>x.id===id); if (!s) return;
  editingId = id;
  document.getElementById('modalTitle').textContent = 'åº—èˆ—ã‚’ç·¨é›†';
  document.getElementById('fName').value = s.name  || '';
  document.getElementById('fAddr').value = s.addr  || '';
  document.getElementById('latlngStatus').textContent = (s.lat && s.lng) ? 'âœ… åº§æ¨™å–å¾—æ¸ˆã¿ (' + s.lat.toFixed(4) + ', ' + s.lng.toFixed(4) + ')' : '';
  document.getElementById('fLat').value  = s.lat   || '';
  document.getElementById('fLng').value  = s.lng   || '';
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(e) { if (e.target===document.getElementById('modalOverlay')) closeModalForce(); }
function closeModalForce() { document.getElementById('modalOverlay').classList.remove('open'); }
function useCurrentLocation() {
  if (!navigator.geolocation) { toast('GPSéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™'); return; }
  const btn = event.currentTarget;
  const origText = btn.innerHTML;
  btn.innerHTML = 'ğŸ“ å–å¾—ä¸­...';
  btn.disabled = true;
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    document.getElementById('fLat').value = lat.toFixed(6);
    document.getElementById('fLng').value = lng.toFixed(6);
    const status = document.getElementById('latlngStatus');
    status.style.color = 'var(--accent)';
    status.textContent = 'âœ… ç¾åœ¨åœ°ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ã—ã¾ã—ãŸ (' + lat.toFixed(4) + ', ' + lng.toFixed(4) + ')';
    // ãƒ›ãƒ¼ãƒ ç”»é¢ã®GPSçŠ¶æ…‹ã‚‚æ›´æ–°
    currentLat = lat; currentLng = lng;
    const dot = document.getElementById('gpsDot');
    const txt = document.getElementById('gpsText');
    if (dot) dot.className = 'gps-dot active';
    if (txt) txt.textContent = `ç¾åœ¨åœ°å–å¾—æ¸ˆã¿ (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
    btn.innerHTML = origText;
    btn.disabled = false;
    toast('ç¾åœ¨åœ°ã®åº§æ¨™ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }, () => {
    btn.innerHTML = origText;
    btn.disabled = false;
    toast('GPSå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
  }, { enableHighAccuracy: true, timeout: 10000 });
}
function saveStore() {
  const name = document.getElementById('fName').value.trim();
  if (!name) { toast('åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const s = {
    id: editingId || `s_${Date.now()}`, name,
    addr: document.getElementById('fAddr').value.trim(),
    lat:  parseFloat(document.getElementById('fLat').value)  || null,
    lng:  parseFloat(document.getElementById('fLng').value)  || null,
  };
  if (editingId) { stores[stores.findIndex(x=>x.id===editingId)] = s; }
  else stores.push(s);
  save(); closeModalForce(); renderStoresList(); renderNearby();
  toast(editingId ? 'åº—èˆ—ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}
function deleteStore(id) {
  const s = stores.find(x => x.id === id);
  if (!s) return;
  const visitCount = visits.filter(v => v.storeId === id).length;

  if (visitCount > 0) {
    // è¨ªå•å±¥æ­´ãŒã‚ã‚‹å ´åˆï¼šé¸æŠè‚¢ã‚’å‡ºã™
    showDeleteStoreDialog(id, s.name, visitCount);
  } else {
    // è¨ªå•å±¥æ­´ãŒãªã„å ´åˆï¼šå˜ç´”ãªç¢ºèª
    showConfirm({
      icon: 'ğŸ—‘ï¸',
      title: 'ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
      msg: s.name,
      okLabel: 'å‰Šé™¤ã™ã‚‹',
      okClass: 'ok-stop',
      onOk: () => {
        stores = stores.filter(x => x.id !== id);
        save(); renderStoresList(); renderNearby();
        toast('åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    });
  }
}
function showDeleteStoreDialog(id, name, visitCount) {
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼šåº—èˆ—ã®ã¿å‰Šé™¤ or å±¥æ­´ã‚‚å‰Šé™¤ ã®2æŠ
  const overlay = document.getElementById('confirmOverlay');
  const box = overlay.querySelector('.confirm-box');
  box.innerHTML = `
    <div class="confirm-icon">ğŸ—‘ï¸</div>
    <div class="confirm-title">${name} ã‚’å‰Šé™¤</div>
    <div class="confirm-msg">ã“ã®åº—èˆ—ã«ã¯ <strong>${visitCount}ä»¶</strong> ã®è¨ªå•å±¥æ­´ãŒã‚ã‚Šã¾ã™ã€‚<br>è¨ªå•å±¥æ­´ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:4px">
      <button class="confirm-btn ok-stop" onclick="doDeleteStore('${id}', false)" style="flex:none">åº—èˆ—ã ã‘å‰Šé™¤ï¼ˆå±¥æ­´ã¯æ®‹ã™ï¼‰</button>
      <button class="confirm-btn" onclick="doDeleteStore('${id}', true)" style="flex:none;background:rgba(255,107,53,0.1);color:var(--warn);border:1px solid rgba(255,107,53,0.3)">åº—èˆ—ã¨å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>
      <button class="confirm-btn cancel" onclick="closeConfirm();restoreConfirmBox()" style="flex:none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>`;
  overlay.classList.add('open');
}
function doDeleteStore(id, deleteHistory) {
  stores = stores.filter(x => x.id !== id);
  if (deleteHistory) {
    visits = visits.filter(v => v.storeId !== id);
  }
  closeConfirm();
  restoreConfirmBox();
  save(); renderStoresList(); renderNearby();
  toast(deleteHistory ? 'åº—èˆ—ã¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ' : 'åº—èˆ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆå±¥æ­´ã¯ä¿æŒï¼‰');
}
function restoreConfirmBox() {
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä½¿ç”¨å¾Œã«å…ƒã®HTMLæ§‹é€ ã‚’å¾©å…ƒ
  const box = document.querySelector('.confirm-box');
  box.innerHTML = `
    <div class="confirm-icon" id="confirmIcon"></div>
    <div class="confirm-title" id="confirmTitle"></div>
    <div class="confirm-msg" id="confirmMsg"></div>
    <div class="confirm-btns">
      <button class="confirm-btn cancel" onclick="closeConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="confirm-btn" id="confirmOkBtn" onclick="confirmOk()"></button>
    </div>`;
}

// ===== UTILS =====
function formatDuration(ms) {
  const t = Math.floor(ms/1000), h = Math.floor(t/3600), m = Math.floor((t%3600)/60), s = t%60;
  if (h>0) return `${h}æ™‚é–“${m}åˆ†`;
  if (m>0) return `${m}åˆ†${s}ç§’`;
  return `${s}ç§’`;
}
function formatDurationShort(ms) {
  const t = Math.floor(ms/1000), h = Math.floor(t/3600), m = Math.floor((t%3600)/60);
  if (h>0) return `${h}h${m}m`;
  return `${m}m`;
}
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ===== INIT =====
window.onload = () => {
  if (session) {
    updateSessionUI(); startSessionTimer();
    Object.keys(checkins).forEach(id => startCheckinTimer(id));
  } else {
    updateSessionUI();
  }
  renderNearby();
};
</script>
</body>
</html>
